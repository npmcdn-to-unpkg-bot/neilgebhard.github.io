<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/css/materialize.css" media="screen,projection" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movies</title>
    <style>
    .card-content .detail {
        margin-right: 20px;
    }
    
    .card-content .detail-group {
        padding-bottom: 5px;
    }
    
    .page-footer {
        background-color: white !important;
    }
    
    footer.page-footer .footer-copyright {
        color: black;
    }
    
    .footer-copyright .fa {
        color: #333;
        font-size: 20px;
        margin-left: 10px;
    }
    
    .fa-heart {
        color: red !important
    }
    
    select.browser-default {
        display: inline-block;
    }
    
    [name="sort_by"] {
        max-width: 200px;
    }
    
    [name="primary_release_year"] {
        max-width: 100px;
    }
    
    [name="with_genres"] {
        max-width: 200px;
    }
    
    .star {
        color: #FFD800
    }
    </style>
</head>

<body>
    <main id="content">
        <main class="container">
            <h3>Movies</h3>
            <form action="">
                <select name="primary_release_year" class="browser-default">
                    <option value="" disabled selected>Year</option>
                    <option value="2016">2016</option>
                    <option value="2015">2015</option>
                    <option value="2014">2014</option>
                    <option value="2013">2013</option>
                    <option value="2012">2012</option>
                    <option value="2011">2011</option>
                    <option value="2010">2010</option>
                    <option value="2009">2009</option>
                    <option value="2008">2008</option>
                    <option value="2007">2007</option>
                    <option value="2006">2006</option>
                    <option value="2005">2005</option>
                    <option value="2004">2004</option>
                    <option value="2003">2003</option>
                    <option value="2002">2002</option>
                    <option value="2001">2001</option>
                    <option value="2000">2000</option>
                    <option value="1999">1999</option>
                    <option value="1998">1998</option>
                    <option value="1997">1997</option>
                    <option value="1996">1996</option>
                    <option value="1995">1995</option>
                    <option value="1994">1994</option>
                    <option value="1993">1993</option>
                    <option value="1992">1992</option>
                    <option value="1991">1991</option>
                    <option value="1990">1990</option>
                    <option value="1989">1989</option>
                    <option value="1988">1988</option>
                    <option value="1987">1987</option>
                    <option value="1986">1986</option>
                    <option value="1985">1985</option>
                    <option value="1984">1984</option>
                    <option value="1983">1983</option>
                    <option value="1982">1982</option>
                    <option value="1981">1981</option>
                    <option value="1980">1980</option>
                    <option value="1979">1979</option>
                    <option value="1978">1978</option>
                    <option value="1977">1977</option>
                    <option value="1976">1976</option>
                    <option value="1975">1975</option>
                    <option value="1974">1974</option>
                    <option value="1973">1973</option>
                    <option value="1972">1972</option>
                    <option value="1971">1971</option>
                    <option value="1970">1970</option>
                </select>
                <select name="sort_by" class="browser-default">
                    <option value="" disabled selected>Sort by</option>
                    <option value="popularity.desc">Highest Popularity</option>
                    <option value="popularity.asc">Lowest Popularity</option>
                    <option value="vote_average.desc">Highest Voting Average</option>
                    <option value="vote_average.asc">Lowest Voting Average</option>
                    <option value="revenue.desc">Highest Grossing</option>
                    <option value="revenue.asc">Lowest Grossing</option>
                </select>
                <select name="with_genres" class="browser-default">
                    <option value="" disabled selected>Genre</option>
                    <option value="12">Adventure</option>
                    <option value="28">Action</option>
                    <option value="12">Adventure</option>
                    <option value="16">Animation</option>
                    <option value="35">Comedy</option>
                    <option value="80">Crime</option>
                    <option value="99">Documentary</option>
                    <option value="18">Drama</option>
                    <option value="10751">Family</option>
                    <option value="14">Fantasy</option>
                    <option value="10769">Foreign</option>
                    <option value="36">History</option>
                    <option value="27">Horror</option>
                    <option value="10402">Music</option>
                    <option value="9648">Mystery</option>
                    <option value="10749">Romance</option>
                    <option value="878">Science Fiction</option>
                    <option value="10770">Movie</option>
                    <option value="53">Thriller</option>
                    <option value="10752">War</option>
                    <option value="37">Western</option>
                </select>
                <button class="btn waves-effect waves-light grey darken-1" type="submit">Go</button> <a class="waves-effect waves-teal btn-flat" href="/movies">Reset</a>
            </form>
            <content id="movies"></content>
        </main>
        <footer class="page-footer">
            <div class="footer-copyright">
                <div class="container">
                    <i class="fa fa-heart" aria-hidden="true"></i> 2016 Neil Gebhard
                    <a class="right" href="https://github.com/neilgebhard/movies"><i class="fa fa-github-alt" aria-hidden="true"></i></a>
                    <a class="right" href="mailto:neilgebhard@gmail.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>
                    <a class="right" href="https://twitter.com/judobaseball"><i class="fa fa-twitter" aria-hidden="true"></i></a>
                    <a class="right" href="https://www.linkedin.com/in/neil-gebhard-3a72068a"><i class="fa fa-linkedin-square" aria-hidden="true"></i></a>
                </div>
            </div>
        </footer>
        <script src="https://use.fontawesome.com/699e05797e.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="/js/materialize.js"></script>
        <script type="text/javascript" src="/lib/moment.js"></script>
        <script>
        // parse url query parameters
        var urlParams;
        (window.onpopstate = function() {
            var match,
                pl = /\+/g,
                search = /([^&=]+)=?([^&]*)/g,
                decode = function(s) {
                    return decodeURIComponent(s.replace(pl, " "));
                },
                query = window.location.search.substring(1);

            urlParams = {};
            while (match = search.exec(query))
                urlParams[decode(match[1])] = decode(match[2]);
        })();

        // update UI
        for (var param in urlParams) {
            $(`[value="${urlParams[param]}"]`).attr('selected', true);
        }

        var GENRES = {
            28: "Action",
            12: "Adventure",
            16: "Animation",
            35: "Comedy",
            80: "Crime",
            99: "Documentary",
            18: "Drama",
            10751: "Family",
            14: "Fantasy",
            10769: "Foreign",
            36: "History",
            27: "Horror",
            10402: "Music",
            9648: "Mystery",
            10749: "Romance",
            878: "Science Fiction",
            10770: "TV Movie",
            53: "Thriller",
            10752: "War",
            37: "Western"
        }

        var IMAGE_URL = 'http://image.tmdb.org/t/p/w500';
        var API_URL = 'https://api.themoviedb.org/3'
        var API_KEY = 'e7daa04756450d99beb62cb1339a0566'
        var url = window.location.href;
        var queryString = url.substring(url.indexOf('?') + 1);
        var monthAgo = moment().subtract(1, 'months').format("YYYY-MM-DD");
        var today = moment().format("YYYY-MM-DD");
        var apiUrl = `${API_URL}/discover/movie?${queryString}&vote_count.gte=10&api_key=${API_KEY}`;
        console.log(apiUrl);
        $.ajax({
            url: apiUrl,
            dataType: 'json'
        }).then(function(res) {
            res.results.forEach(function(result) {
                var genreListing = "";
                result.genre_ids.forEach(function(id) {
                    genreListing += genreListing ? ', ' : '';
                    genreListing += GENRES[id] ? GENRES[id] : '';
                });
                $("#movies").append(`
                    <div class="card horizontal">
                        <div class="card-image">
                            <img src="${IMAGE_URL + result.poster_path}" style="height: 250px">
                        </div>
                        <div class="card-stacked">
                            <div class="card-content">
                                <h5>${result.title}</h5>
                                <p class="detail-group">
                                    <span class="detail">${moment(result.release_date).format('LL')}</span> 
                                </p>
                                <p class="detail-group">
                                    <i>${genreListing}</i> 
                                </p>
                                <p class="detail-group">
                                    <span class="detail">
                                        <i class="material-icons tooltipped star" data-position="top" data-delay="50" data-tooltip="Vote average">star</i> ${result.vote_average}
                                    </span>
                                    <span class="detail">Votes: ${result.vote_count}</span>
                                    <span class="detail">
                                        <i class="material-icons tooltipped" data-position="top" data-delay="50" data-tooltip="Popularity">trending_up</i> ${result.popularity.toFixed(2)}
                                    </span> 
                                </p>
                                <p>${result.overview}</p>
                            </div>
                        </div>
                    </div>`);
            });
            $('.tooltipped').tooltip({
                delay: 50
            });
        });
        </script>
</body>

</html>
